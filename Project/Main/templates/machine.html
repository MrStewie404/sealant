{% load static %}
{% load filters %}
{% block content %}
<div id="table_result">
    <div id="result_message" class="result-message" style="display: flex; justify-content: space-between;">
        <p id="amount_machine" style="font-family: AstraBold; font-size: larger; margin: 0;">&nbsp;</p>
    </div>
    <div>
        <div style="display: flex; flex-direction: row; width: 100%; justify-content: space-between;">
            <div>
                {% for group in request.user.groups.values_list %}
                    {% if group|in_group:"Manager" %}
                        <a href="/create/machine/">
                            <button class="different_button" style="width: 100%; margin-left: 0; font-size: 15px;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∞—à–∏–Ω—É</button>
                        </a>
                    {% endif %}
                {% endfor %}
            </div>
            <button id="search-button" type="submit">–ü–æ–∏—Å–∫</button>
        </div>
        <p style="width: 100%; background-color: rgba(255, 255, 255, 0.404); height: 5px; margin: 0 auto;"></p>
    </div>
    <div style="overflow-x: auto; max-width: 100%; max-height: 100%; background-color: rgba(0, 0, 0, 0.3);">
        <table>
            <thead>
                <tr id="table_titles_machine" style="background-color: rgb(98, 95, 89); color: white;">
                    <th>
                        –ó–∞–≤. ‚Ññ –º–∞—à–∏–Ω—ã
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="serial_number">
                         <div style="display: flex; width: 50%;">
                            <button id="serial_number__Asc" class="sort-button" >üîº</button>
                            <button id="serial_number__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ú–æ–¥–µ–ª—å —Ç–µ—Ö–Ω–∏–∫–∏
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="equipment_model__name">
                         <div style="display: flex; width: 50%;">
                            <button id="equipment_model__name__Asc" class="sort-button" >üîº</button>
                            <button id="equipment_model__name__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ú–æ–¥–µ–ª—å –¥–≤–∏–≥–∞—Ç–µ–ª—è
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="engine_model__name">
                         <div style="display: flex; width: 50%;">
                            <button id="engine_model__name__Asc" class="sort-button" >üîº</button>
                            <button id="engine_model__name__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ó–∞–≤. ‚Ññ –¥–≤–∏–≥–∞—Ç–µ–ª—è
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="engine_serial_number">
                        <div style="display: flex; width: 50%;">
                            <button id="engine_serial_number__Asc" class="sort-button" >üîº</button>
                            <button id="engine_serial_number__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ú–æ–¥–µ–ª—å —Ç—Ä–∞–Ω—Å–º–∏—Å—Å–∏–∏
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="transmission_model__name">
                         <div style="display: flex; width: 50%;">
                            <button id="transmission_model__name__Asc" class="sort-button" >üîº</button>
                            <button id="transmission_model__name__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ó–∞–≤. ‚Ññ —Ç—Ä–∞–Ω—Å–º–∏—Å—Å–∏–∏
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="transmission_serial_number">
                         <div style="display: flex; width: 50%;">
                            <button id="transmission_serial_number__Asc" class="sort-button" >üîº</button>
                            <button id="transmission_serial_number__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ú–æ–¥–µ–ª—å –≤–µ–¥—É—â–µ–≥–æ –º–æ—Å—Ç–∞
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="drive_axle_model__name">
                        <div style="display: flex; width: 50%;">
                            <button id="drive_axle_model__name__Asc" class="sort-button" >üîº</button>
                            <button id="drive_axle_model__name__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ó–∞–≤. ‚Ññ –≤–µ–¥—É—â–µ–≥–æ –º–æ—Å—Ç–∞
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="drive_axle_serial_number">
                        <div style="display: flex; width: 50%;">
                            <button id="drive_axle_serial_number__Asc" class="sort-button" >üîº</button>
                            <button id="drive_axle_serial_number__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                     <th>
                        –ú–æ–¥–µ–ª—å —É–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ –º–æ—Å—Ç–∞
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="steerable_axle_model__name">
                         <div style="display: flex; width: 50%;">
                            <button id="steerable_axle_model__name__Asc" class="sort-button" >üîº</button>
                            <button id="steerable_axle_model__name__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ó–∞–≤. ‚Ññ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ –º–æ—Å—Ç–∞
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="steerable_axle_serial_number">
                        <div style="display: flex; width: 50%;">
                            <button id="steerable_axle_serial_number__Asc" class="sort-button" >üîº</button>
                            <button id="steerable_axle_serial_number__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏ ‚Ññ, –¥–∞—Ç–∞
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="supply_contract_number">
                         <div style="display: flex; width: 50%;">
                             <button id="supply_contract_number__Asc" class="sort-button" >üîº</button>
                            <button id="supply_contract_number__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏ —Å –∑–∞–≤–æ–¥–∞
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="date" id="shipment_date">
                        <div style="display: flex; width: 50%;">
                            <button id="shipment_date__Asc" class="sort-button" >üîº</button>
                           <button id="shipment_date__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ì—Ä—É–∑–æ–ø–æ–ª—É—á–∞—Ç–µ–ª—å (–∫–æ–Ω–µ—á–Ω—ã–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å)
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="consignee">
                        <div style="display: flex; width: 50%;">
                           <button id="consignee__Asc" class="sort-button" >üîº</button>
                            <button id="consignee__Desc" class="sort-button" >üîΩ</button>
                        </div>
                    </th>
                    <th>
                        –ê–¥—Ä–µ—Å –ø–æ—Å—Ç–∞–≤–∫–∏ (—ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏)
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="delivery_address">
                       <div style="display: flex; width: 50%;">
                           <button id="delivery_address__Asc" class="sort-button" >üîº</button>
                           <button id="delivery_address__Desc" class="sort-button" >üîΩ</button>
                       </div>
                    </th>
                     <th>
                        –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è (–¥–æ–ø. –æ–ø—Ü–∏–∏)
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="configuration">
                       <div style="display: flex; width: 50%;">
                           <button id="configuration__Asc" class="sort-button" >üîº</button>
                           <button id="configuration__Desc" class="sort-button" >üîΩ</button>
                       </div>
                    </th>
                    <th>
                        –ö–ª–∏–µ–Ω—Ç
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="client">
                        <div style="display: flex; width: 50%;">
                           <button id="client__Asc" class="sort-button" >üîº</button>
                           <button id="client__Desc" class="sort-button" >üîΩ</button>
                       </div>
                    </th>
                    <th>
                        –°–µ—Ä–≤–∏—Å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è
                        <input class="search-input" style="border: solid white 2px; transition: all 1s;" type="text" id="service_company__name">
                        <div style="display: flex; width: 50%;">
                           <button id="service_company__name__Asc" class="sort-button" >üîº</button>
                           <button id="service_company__name__Desc" class="sort-button" >üîΩ</button>
                       </div>
                    </th>
                </tr>
            </thead>
            <tbody id="table_data">
            </tbody>
        </table>
    </div>
</div>
<script>
    const machines_api = new WebSocket("ws://localhost:9090/api/machines/");
    let machinesWaitingOn = false;
    let machineMemoryInput = ' ';

    machines_api.onmessage = function(e) {
        const search_result = document.querySelector('#amount_machine')

        try{
            const responseData = JSON.parse(e.data);
            if (responseData.error) {
                search_result.textContent = `${responseData.description}`
            } else {
                search_result.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞: ${responseData.machine_info.length}`
                const tableResult = document.querySelector('#result_message');
                const tableTitles = document.querySelector('#table_titles_machine');
                const tableData = document.querySelector('#table_data');
                tableResult.style.color = 'black';
                tableData.style.backgroundColor = 'rgb(202, 200, 191)';
                tableData.style.color = 'black';
                tableTitles.style.backgroundColor = 'rgb(98, 95, 89)';
                let html = ``;
                responseData.machine_info.forEach(object => {
                    html += `<tr id="machine_${object.id}" style="background-color: rgb(234, 229, 216); transition: all 1s;"></tr>`;
                })
                document.querySelector('#table_data').innerHTML = html;
                responseData.machine_info.forEach(object =>{
                    let html = ``;
                    responseData.fields.forEach(field => {
                        if(object.hasOwnProperty(field)) {
                            if (object[field].hasOwnProperty('name')) {
                                html += `<td> <a style="text-decoration: none;" href="/description/?last_page=${window.location.href}&table_title=${123}&name=${object[field]['name']}&description=${object[field]['description']}" class="clue" style="text-decoration: underline"; data-clue="${object[field]['description']}" target="_blank"> ${object[field]['name']} </a> </td>`;
                            } else {
                                html += `<td>${object[field]}</td>`;
                            }
                        }
                        document.querySelector(`#machine_${object.id}`).innerHTML = html;
                    })
                });
            }
            machinesWaitingOn = false;
            
        } catch (e) {
           console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON', e)
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        const tableTitles = document.getElementById('table_titles_machine');
        const searchButton = document.querySelector('#search-button');

        if (tableTitles) {
            const inputs = tableTitles.querySelectorAll('input.search-input');
            const sortButtons = tableTitles.querySelectorAll('button.sort-button');
             let activeInput = null;


            inputs.forEach(currentInput => {
                currentInput.addEventListener('input', function() {
                    inputs.forEach(input => {
                        if (input !== currentInput) {
                            input.value = '';
                        }
                    });activeInput = currentInput;
                    sendRequestToServer();
                });
            });
             sortButtons.forEach(button => {
                button.addEventListener('click', function() {
                    sortButtons.forEach(btn => {
                        if (btn !== button) {
                            btn.classList.remove('active')
                        }
                    });
                    button.classList.toggle('active');
                    sendRequestToServer();
                });
            });
             searchButton.onclick = function() {
                 sendRequestToServer();
             };

           function sendRequestToServer() {
                const activeSortButtons = [];
                sortButtons.forEach(button => {
                    if (button.classList.contains('active')) {
                        activeSortButtons.push(button.id);
                    }
                });
                let requestData = {
                    api_key: userid,
                    filterBy: activeSortButtons,
                };
                if(activeInput && activeInput.value !== '') {
                    requestData.query = [
                        activeInput.id, activeInput.value
                    ]
                    requestData.filterBy = [
                        activeInput.id,
                        ...activeSortButtons
                    ]
                }
                machines_api.send(JSON.stringify(requestData));
            }
        }
    });

    // TODO –≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞
    function waiting_answer() {
        const machineSerialNumber = document.querySelector('#factory_number');
        machineSerialNumber.style.border = 'solid 2px rgb(33, 61, 105)'
        setTimeout(() => {
            machineSerialNumber.style.border = 'solid 2px white';
        }, 1000);
        if (machinesWaitingOn == true) {
             console.log('waiting...');
            setTimeout(() => {
                waiting_answer(machinesWaitingOn);
            }, 1500);
        }
    }

    machines_api.onopen = () => {
        console.log('WebSocket connection opened');
    };

    machines_api.onerror = (error) => {
        console.error('WebSocket error:', error);
    };

    machines_api.onclose = (event) => {
        if (event.wasClean) {
            console.log(`WebSocket connection closed cleanly, code=${event.code}`);
        } else {
            console.error('WebSocket connection died');
        }
    };
</script>
{% endblock %}